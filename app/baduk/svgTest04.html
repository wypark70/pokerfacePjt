<html ng-app="d3test">
<head>
    <link rel="stylesheet" href="../../libs/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../libs/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <style>
        body {
            margin: 0px;
            padding: 5px;
        }
        svg {
            background-image: url("../../images/Diffusion/inkinwater5.jpg");
            background-size: cover;
        }
        #panGroup line {
            stroke: #000000;
            stroke-width: 3;
        }
        #panGroup rect {
            fill: yellow;
        }
        #giboGroup circle {
            stroke: #000000;
            stroke-width: 1;
        }
        #squaresGroup rect {
            stroke: #000000;
            stroke-width: 1;
        }
    </style>
</head>
<body ng-controller="d3testCtrl">
<div class="container theme-showcase" role="main">
    <nav class="navbar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Project name</a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#contact">Contact</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="#">Action</a></li>
                            <li><a href="#">Another action</a></li>
                            <li><a href="#">Something else here</a></li>
                            <li class="divider"></li>
                            <li class="dropdown-header">Nav header</li>
                            <li><a href="#">Separated link</a></li>
                            <li><a href="#">One more separated link</a></li>
                        </ul>
                    </li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
    <div class="alert alert-info" role="alert">
        <strong>circlesLength: </strong> {{circles.length}}<br />
        <strong>squaresLength: </strong> {{squares.length}}
    </div>
    <ng-view></ng-view>
    <div class="panel panel-default">
        <div class="panel-heading">
            <button type="button" class="btn btn-xs btn-info" ng-click="addCircles()">Add circles</button>
            <button type="button" class="btn btn-xs btn-info" ng-click="clearCircles()">Clear circles</button>
            <button type="button" ng-class="toggleCircleBtnClass" ng-click="toggleCircleVisibility()">Toggle circle visibility</button>
            <button type="button" class="btn btn-xs btn-info" ng-click="addSquares()">Add squares</button>
            <button type="button" class="btn btn-xs btn-info" ng-click="clearSquares()">Clear squares</button>
            <button type="button" ng-class="toggleSquaresBtnClass" ng-click="toggleSquareVisibility()">Toggle square visibility</button>
        </div>
        <div class="panel-body">
            <svg viewBox="0 0 2000 2000">
                <g id="panGroup" d3 d3-data="lines" d3-renderer="lineRenderer"></g>
                <g id="squaresGroup" d3 d3-data="squares" d3-renderer="squareRenderer" ng-show="$parent.showSquares"></g>
                <g id="giboGroup" d3 d3-data="circles" d3-renderer="circleRenderer" ng-show="$parent.showCircles"></g>
            </svg>
        </div>
    </div>
</div>

<script src="../../libs/jquery/1.9.1/jquery-1.9.1.min.js"></script>
<script src="libs/bootstrap/3.3.2/bootstrap.min.js"></script>
<script src="../../libs/d3/3.0.8/d3.min.js"></script>
<script src="../../libs/angular.js/1.1.1/angular.min.js"></script>
<script src="../../js/angular-d3.js"></script>
<script>
    angular.module('d3test', ['d3']).controller("d3testCtrl", function ($scope) {
        $scope.showCircles = true;
        $scope.toggleCircleBtnClass = ['btn', 'btn-xs', 'btn-info'];
        $scope.showSquares = true;
        $scope.toggleSquaresBtnClass = ['btn', 'btn-xs', 'btn-info'];
        $scope.currentDolColor = "black";
        $scope.lines = [];
        $scope.dotCircles = [];
        $scope.circles = [];
        $scope.squares = [];
        $scope.width = 2000;
        $scope.height = 2000;
        $scope.dx = $scope.width / 20;
        $scope.dy = $scope.height / 20;
        $scope.startX = $scope.dx;
        $scope.startY = $scope.dy;
        $scope.endX = $scope.width - $scope.dx;
        $scope.endY = $scope.height - $scope.dy;
        $scope.lineRenderer = function(el, data) {
            var l = el.selectAll('line').data($scope.lines);
            l.enter()
                    .append('line')
                    .attr("x1", function(d) { return d.x1; })
                    .attr("y1", function(d) { return d.y1; })
                    .attr("x2", function(d) { return d.x2; })
                    .attr("y2", function(d) { return d.y2; });
            var c = el.selectAll('circle').data($scope.dotCircles);
            c.enter()
                    .append("circle")
                    .attr('cx', $scope.width / 2)
                    .attr('cy', $scope.height / 2)
                    .attr('opacity', function(d) { return d.opacity; })
                    .style('fill', function(d) { return d.fill; })
                    .transition()
                    .duration(1000)
                    .attr('cx', function(d) { return d.cx; })
                    .attr('cy', function(d) { return d.cy; })
                    .attr('r', function(d) { return d.r;});
        };
        $scope.addLines = function() {
            d3.range($scope.startX, $scope.endX + 1, $scope.dx).forEach(function(d) {
                $scope.lines.push({x1: d, y1: $scope.startY, x2: d, y2: $scope.endY});
            });
            d3.range($scope.startY, $scope.endY + 1, $scope.dy).forEach(function(d) {
                $scope.lines.push({x1: $scope.startX, y1: d, x2: $scope.endX, y2: d});
            });
        };
        $scope.addDotCircles = function() {
            var dotArr = [
                {x:4, y:4}, {x:4, y:10}, {x:4, y:16},
                {x:10, y:4}, {x:10, y:10}, {x:10, y:16},
                {x:16, y:4}, {x:16, y:10}, {x:16, y:16}
            ];
            dotArr.forEach(function(d) {
                $scope.dotCircles.push({cx: $scope.dx * d.x, cy: $scope.dy * d.y, r: 15, fill: "black", opacity: 1});
            })
        };
        $scope.addLines();
        $scope.addDotCircles();
        $scope.circleRenderer = function(el, data) {
            var d = el.selectAll('circle').data($scope.circles);
            d.enter()
                    .append('circle')
                    .on("click", $scope.updateCircle)
                    .attr('cx', $scope.width / 2)
                    .attr('cy', $scope.height / 2)
                    .attr('opacity', 1)
                    .style('fill', function(d) { return d.fill; })
                    .transition()
                    .duration(1000)
                    .attr('opacity', function(d) { return d.opacity; })
                    .attr('cx', function(d) { return d.cx; })
                    .attr('cy', function(d) { return d.cy; })
                    .attr('r', function(d) { return d.r;});
            d.exit()
                    .transition()
                    .duration(1000)
                    .attr('cx', $scope.width / 2)
                    .attr('cy', $scope.height / 2)
                    .attr('r', 0)
                    .remove();
        };
        $scope.addCircles = function() {
            if ($scope.circles.length > 0) {
                return false;
            }
            var r = Math.min($scope.dx, $scope.dy) / 2 - 2;
            for(var x = 1; x < 20; x++) {
                for(var y = 1; y < 20; y++) {
                    $scope.circles.push({cx: x *  $scope.dx, cy: y * $scope.dy, r: r, fill: "green", opacity: 0});
                }
            }
        };
        $scope.addCircles();
        $scope.updateCircle = function() {
            var data = d3.select(this).data()[0];
            if ("green" == data.fill) {
                data.fill = $scope.currentDolColor;
                data.opacity = 1;
                $scope.currentDolColor = "black" == $scope.currentDolColor ? "white" : "black";
            }
            else {
                data.fill = "green";
                data.opacity = 0;
            }
            d3.select(this)
                    .attr('opacity', 0)
                    .style('fill', data.fill)
                    .transition()
                    .duration(1000)
                    .attr('opacity', data.opacity)
                    .style('fill', data.fill);
            $scope.$apply();
        };
        $scope.clearCircles = function() {
            $scope.circles = [];
        };
        $scope.toggleCircleVisibility = function() {
            $scope.showCircles = !$scope.showCircles;
            if($scope.showCircles) $scope.toggleCircleBtnClass = ['btn', 'btn-xs', 'btn-info'];
            else $scope.toggleCircleBtnClass = ['btn', 'btn-xs', 'btn-danger'];
        };
        $scope.squareRenderer = function(el, data) {
            var d = el.selectAll('rect').data($scope.squares);
            d.enter()
                    .append('rect')
                    .attr('x', $scope.width / 2)
                    .attr('y', $scope.height / 2)
                    .attr('width', 0)
                    .attr('height', 0)
                    .style('fill', function() { return 'rgb(' + parseInt(Math.random() * 255) + ',' + parseInt(Math.random() * 255) + ',' + parseInt(Math.random() * 255) + ')'; })
                    .transition()
                    .duration(1000)
                    .attr('x', function(d) { return d.x - d.size / 2; })
                    .attr('y', function(d) { return d.y - d.size / 2; })
                    .attr('width', function(d) { return d.size; })
                    .attr('height', function(d) { return d.size; });
            d.exit()
                    .transition()
                    .duration(1000)
                    .attr('x', $scope.width / 2)
                    .attr('y', $scope.height / 2)
                    .attr('width', 0)
                    .attr('height', 0)
                    .remove();
        };
        $scope.addSquares = function() {
            for (var i = 0; i < 50; i++) {
                var x = (Math.round((Math.random() * ($scope.endX - $scope.startX) / $scope.dx)) + 1) *  $scope.dx;
                var y = (Math.round((Math.random() * ($scope.endY - $scope.startY) / $scope.dy)) + 1) *  $scope.dy;
                var s = Math.min($scope.dx, $scope.dy) * 0.75 ;
                $scope.squares.push({x: x, y: y, size: s});
                //$scope.squares.push({x: Math.random() * $scope.width, y: Math.random() * $scope.height, size: Math.random() * 50});
            }
        };
        $scope.clearSquares = function() {
            $scope.squares = [];
        };
        $scope.toggleSquareVisibility = function() {
            $scope.showSquares = !$scope.showSquares;
            if($scope.showSquares) $scope.toggleSquaresBtnClass = ['btn', 'btn-xs', 'btn-info'];
            else $scope.toggleSquaresBtnClass = ['btn', 'btn-xs', 'btn-danger'];
        };
    });
</script>
</body>
</html>