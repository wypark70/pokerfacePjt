<!DOCTYPE html>
<html>
<head>
    <title>xlsToXml</title>

    <link href="css/infragistics.theme.css" rel="stylesheet" />
    <link href="css/infragistics.css" rel="stylesheet" />
    <link href="css/infragistics.ui.treegrid.css" rel="stylesheet" />
    <script src="js/modernizr-latest.js"></script>
    <script src="libs/jquery/1.9.1/jquery-1.9.1.min.js"></script>
    <script src="libs/jquery/plugin/jquery-ui.min.js"></script>
    <script src="js/infragistics.core.js"></script>
    <script src="js/infragistics.lob.js"></script>
    <script src="js/infragistics.ui.treegrid.js"></script>
    <script src="js/json2.js"></script>
    <script src="libs/jquery/plugin/jquery.csv-0.71.js"></script>
    <script src="libs/jquery/plugin/jquery.json2xml.js"></script>
    <style>
        #grid_container {
            width: 100%;
        }
        body {
            font: 12px "Segoe UI",Helvetica,Tahoma,Arial,Verdana,sans-serif;
            min-width: 280px;
            min-height: 700px;
            color: #495555;
        }
    </style>

    <link rel="stylesheet" href="css/codemirror.css">
    <link rel="stylesheet" href="css/dialog.css">
    <script src="js/codemirror.js"></script>
    <script src="js/dialog.js"></script>
    <script src="js/searchcursor.js"></script>
    <script src="js/clike.js"></script>
    <script src="js/matchbrackets.js"></script>
    <script src="js/xml.js"></script>
    <script src="js/vim.js"></script>
    <style type="text/css">
        .CodeMirror {
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            height: 700px;
        }
    </style>

    <script src="js/shim.js"></script>
    <script src="js/xls.js"></script>

    <style type="text/css">
        fieldset {
            display: block;
            margin-left: 2px;
            margin-right: 2px;
            padding-top: 0.35em;
            padding-bottom: 0.625em;
            padding-left: 0.75em;
            padding-right: 0.75em;
            border: 2px groove;
        }
    </style>
</head>
<body>

<fieldset style="float: left;">
    <legend>Soruce XLS file</legend>
    XLS 파일 선택: <input id="the-file-input" type="file" accept=".xls">
</fieldset>

<fieldset>
    <legend>XML Options</legend>
    rootName: <input id="rootName" type="text" value="columns">&nbsp;&nbsp;
    objectName: <input id="objectName" type="text" value="column">
</fieldset>

<div id="tabs">
    <ul>
        <li id="tab1"><a href="#tabs-1">csv source</a></li>
        <li id="tab2"><a href="#tabs-2">to json</a></li>
        <li id="tab3"><a href="#tabs-3">to xml</a></li>
        <li id="tab4"><a href="#tabs-4">to grid</a></li>
    </ul>
    <div id="tabs-1" style="padding: 0px;">
        <textarea id="csvData" name="csvData">Name,Required,Index,Condition,Value
Ver,True,0,&gt;=,0
Time,True,1,&gt;=,0
Instance,True,2,&gt;=,0
NE_Type,True,3,&gt;=,0
NE_ID,True,4,&gt;=,0</textarea>
    </div>
    <div id="tabs-2" style="padding: 0px;">
        <textarea id="json" name="json"></textarea>
        <div id="jsonDiv"></div>
    </div>
    <div id="tabs-3" style="padding: 0px;">
        <textarea id="xmlCode" name="xmlCode"></textarea>
    </div>
    <div id="tabs-4" style="padding: 0px;">
        <div id="gridDiv"></div>
    </div>
</div>


<script>
    $(function () {
        var csvEditor = CodeMirror.fromTextArea(document.getElementById("csvData"), {
            lineNumbers: true,
            mode: "xml",
            keyMap: "vim",
            matchBrackets: true,
            showCursorWhenSelecting: true
        });

        var jsonEditor = CodeMirror.fromTextArea(document.getElementById("json"), {
            lineNumbers: true,
            matchBrackets: true,
            continueComments: "Enter",
            extraKeys: {"Ctrl-Q": "toggleComment"}
        });

        var xmlEditor = CodeMirror.fromTextArea(document.getElementById("xmlCode"), {
            lineNumbers: true,
            mode: "xml",
            keyMap: "vim",
            matchBrackets: true,
            showCursorWhenSelecting: true
        });

        $("#tabs").tabs({
            activate: function(event, ui) {
                var csvData = csvEditor.getValue();
                var data = $.csv.toObjects(csvData);
                var tabId = $(ui.newTab).attr("id");
                if ("tab1" == tabId) {
                    csvEditor.refresh();
                }
                else if ("tab2" == tabId) {
                    jsonEditor.setValue(JSON.stringify(data, null, '\t'));
                    jsonEditor.refresh();
                }
                else if ("tab3" == tabId) {
                    var newData = new Array();
                    $.each(data, function() {
                        //newData.push($.extend(this, {"Value": {"Condition": this.Condition, "Value": this.Value}}));
                        newData.push({
                            "Name" : this.Name,
                            "Required": this.Required,
                            "Index": this.Index,
                            "Value": {"Condition": this.Condition, "Value": this.Value}
                        });
                    });
                    console.log(JSON.stringify(newData, null, '\t'));
                    var data2 = eval("({" + $("#objectName").val() + ": newData})");
                    var xmlCode = $.json2xml(data2, {rootTagName: $("#rootName").val(), formatOutput: true});
                    xmlEditor.setValue(xmlCode);
                    xmlEditor.refresh();
                }
                else if ("tab4" == tabId) {
                    var $gridDiv = $("#gridDiv");
                    var $gridTable = $('<table id="grid"></table>');
                    $gridDiv.empty();
                    $gridDiv.append($gridTable);
                    $gridTable.igGrid({
                        dataSource: data,
                        features: [
                            {
                                name: "Filtering",
                                type: "local"
                            },
                            {
                                name: "Sorting",
                                type: "local"
                            },
                            {
                                name: 'Paging',
                                type: "local",
                                pageSize: 20
                            }
                        ]
                    });
                }
            }
        });

        function xw_xfer(data, cb) {
            var worker = new Worker("js/xlsworker2.js");
            console.log(worker);
            worker.onmessage = function(e) {
                switch(e.data.t) {
                    case 'ready': break;
                    case 'e': break;
                    default: xx=ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"); console.log("done"); cb(JSON.parse(xx)); break;
                }
            };
            var val = s2ab(data);
            worker.postMessage(val[1], [val[1]]);
        }

        function ab2str(data) {
            var o = "", l = 0, w = 10240;
            for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
            o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
            return o;
        }

        function s2ab(s) {
            var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
            for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
            return [v, b];
        }

        function process_wb(wb) {
            XLS.SSF.load_table(wb.SSF);
            var output = to_csv(wb);
            csvEditor.setValue(output);
            $("#tabs").tabs("option", "active", 0);
        }

        function to_csv(workbook) {
            var result = [];
            workbook.SheetNames.forEach(function(sheetName) {
                var csv = XLS.utils.sheet_to_csv(workbook.Sheets[sheetName]);
                if(csv.length > 0){
                    //result.push("SHEET: " + sheetName);
                    //result.push("");
                    result.push(csv);
                }
                return false;
            });
            return result.join("\n");
        }

        $("#the-file-input").change(function(evt) {
            var file = evt.target.files[0];
            console.log(file);
            var reader = new FileReader();
            reader.readAsBinaryString(file);
            reader.onload = function(event) {
                var data = event.target.result;
                xw_xfer(data, process_wb);
            };
            reader.onerror = function () {
                alert('Unable to read ' + file.fileName);
            };
        });
    });
</script>
</body>
</html>